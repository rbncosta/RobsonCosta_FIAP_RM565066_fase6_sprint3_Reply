-- Hermes Reply – Fase 5 (PT-BR) — RM 565066
-- Esquema Oracle 12c+ com IDENTITY e VIEWS adicionais

CREATE TABLE PLANTA (
  PLANTA_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NOME          VARCHAR2(80) NOT NULL,
  LOCALIDADE    VARCHAR2(120)
);

CREATE TABLE ATIVO (
  ATIVO_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  PLANTA_ID     NUMBER NOT NULL,
  NOME          VARCHAR2(80) NOT NULL,
  TIPO          VARCHAR2(40) NOT NULL,
  DATA_INSTALACAO DATE,
  CONSTRAINT FK_ATIVO_PLANTA FOREIGN KEY (PLANTA_ID) REFERENCES PLANTA(PLANTA_ID)
);

CREATE TABLE SENSOR (
  SENSOR_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ATIVO_ID      NUMBER NOT NULL,
  TIPO_SENSOR   VARCHAR2(40) NOT NULL CHECK (TIPO_SENSOR IN ('TEMPERATURA','VIBRACAO','UMIDADE')),
  UNIDADE       VARCHAR2(20) NOT NULL CHECK (UNIDADE IN ('C','MM_S','PCT')),
  VALOR_MIN     NUMBER,
  VALOR_MAX     NUMBER,
  DATA_CALIBRACAO DATE,
  CONSTRAINT UQ_SENSOR_ATIVO_TIPO UNIQUE (ATIVO_ID, TIPO_SENSOR),
  CONSTRAINT FK_SENSOR_ATIVO FOREIGN KEY (ATIVO_ID) REFERENCES ATIVO(ATIVO_ID)
);

CREATE TABLE LEITURA_SENSOR (
  LEITURA_ID    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  SENSOR_ID     NUMBER NOT NULL,
  DATA_HORA     TIMESTAMP NOT NULL,
  VALOR         NUMBER NOT NULL,
  CONSTRAINT FK_LEITURA_SENSOR FOREIGN KEY (SENSOR_ID) REFERENCES SENSOR(SENSOR_ID),
  CONSTRAINT CK_VALOR_FAIXA CHECK (VALOR > -200 AND VALOR < 1000)
);

CREATE TABLE EVENTO_MANUTENCAO (
  EVENTO_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ATIVO_ID      NUMBER NOT NULL,
  DATA_HORA     TIMESTAMP NOT NULL,
  TIPO_EVENTO   VARCHAR2(40) NOT NULL CHECK (TIPO_EVENTO IN ('INSPECAO','REPARO','FALHA')),
  SEVERIDADE    NUMBER CHECK (SEVERIDADE BETWEEN 1 AND 5),
  DESCRICAO     VARCHAR2(400),
  CONSTRAINT FK_EVT_ATIVO FOREIGN KEY (ATIVO_ID) REFERENCES ATIVO(ATIVO_ID)
);

-- Índices úteis
CREATE INDEX IDX_LEITURA_SENSOR_TS ON LEITURA_SENSOR(SENSOR_ID, DATA_HORA);
CREATE INDEX IDX_EVT_ATIVO_TS      ON EVENTO_MANUTENCAO(ATIVO_ID, DATA_HORA);

-- VIEWS específicas
-- Últimas 24h de leituras
CREATE OR REPLACE VIEW V_LEITURAS_24H AS
SELECT L.SENSOR_ID, L.DATA_HORA, L.VALOR
FROM LEITURA_SENSOR L
WHERE L.DATA_HORA >= SYSTIMESTAMP - INTERVAL '24' HOUR;

-- Resumo horário por ativo (médias)
CREATE OR REPLACE VIEW V_RESUMO_ATIVO_HORA AS
SELECT A.ATIVO_ID,
       CAST(L.DATA_HORA AS DATE) AS DIA,
       EXTRACT(HOUR FROM L.DATA_HORA) AS HORA,
       AVG(L.VALOR) AS MEDIA_VALOR
FROM LEITURA_SENSOR L
JOIN SENSOR S ON S.SENSOR_ID = L.SENSOR_ID
JOIN ATIVO  A ON A.ATIVO_ID  = S.ATIVO_ID
GROUP BY A.ATIVO_ID, CAST(L.DATA_HORA AS DATE), EXTRACT(HOUR FROM L.DATA_HORA);

-- Possíveis anomalias (fora do range de calibração quando disponível)
CREATE OR REPLACE VIEW V_ANOMALIAS AS
SELECT L.LEITURA_ID, S.SENSOR_ID, S.TIPO_SENSOR, L.DATA_HORA, L.VALOR
FROM LEITURA_SENSOR L
JOIN SENSOR S ON S.SENSOR_ID = L.SENSOR_ID
WHERE (S.VALOR_MIN IS NOT NULL AND L.VALOR < S.VALOR_MIN)
   OR (S.VALOR_MAX IS NOT NULL AND L.VALOR > S.VALOR_MAX);
